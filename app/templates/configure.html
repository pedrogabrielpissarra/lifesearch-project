{% extends "base.html" %}

{% block content %}
<div class="pt-4">
    <h2>Configure Weights</h2>
    <p class="lead">Adjust weights (0.0 to 1.0) for each factor used in habitability calculations. Default values are 1.0 for general factors and 0.25 for PHI components.</p>

<!-- Nova seção para valores de referência -->
<div class="card mb-4">
    <div class="card-header bg-info text-white">
        <h3 class="h5 mb-0">Reference Values</h3>
    </div>
    <div class="card-body">
        {% if reference_values %}
            <div class="table-responsive">
                <table id="reference-values-table" class="table table-striped">
                    <thead>
                        <tr>
                            <th>Planet</th>
                            <th>ESI</th>
                            <th>PHI</th>
                            <th>Classification</th>
                        </tr>
                    </thead>
                    <tbody id="reference_values">
                        {% for planet in reference_values %}
                            <tr>
                                <td>{{ planet.name }}</td>
                                <td>{{ "%.2f"|format(planet.esi) }}%</td>
                                <td>{{ "%.2f"|format(planet.phi) }}%</td>
                                <td>{{ planet.classification }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i> No planets selected. Search for planets first to see reference values.
            </div>
        {% endif %}
        
        <div class="mt-3">
            <p><strong>Note:</strong> These values are calculated using the current weights. Adjusting weights below will affect these values in the generated reports.</p>
        </div>
    </div>
</div>

    <!-- Seção para pesos individuais por planeta -->
    <div class="mb-4">
        <h3>Weights per Planet</h3>
        <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="use-individual-weights" name="use-individual-weights">
            <label class="form-check-label" for="use-individual-weights">
                Setup individual weights
            </label>
        </div>
    
        <div id="planet-weights-container" style="display: none;">
            <!-- Será preenchido via JavaScript -->
        </div>
        <!-- Botão para salvar todos os pesos individuais -->
        <div id="save-individual-weights-button-container" class="d-grid gap-2 col-6 mx-auto mt-3 mb-3" style="display: none;">
             <button type="button" id="save-all-individual-weights-btn" class="btn btn-primary btn-lg">Save All Individual Planet Weights</button>
        </div>
    </div>
        <div class="alert alert-secondary d-flex justify-content-between align-items-center">
        <span><i class="bi bi-arrow-left-circle"></i> Want to generate report with saved parameters?</span>
        <a href="{{ url_for('routes.index') }}?restore=1" class="btn btn-outline-primary btn-sm">Back to Search and Generate Reports</a>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Função de normalização no JavaScript
function normalizePlanetName(name) {
    if (!name || typeof name !== 'string') return '';
    name = name.trim().replace(/–/g, '-').replace(/\s+/g, '');
    return name.toLowerCase().replace(/[^a-z0-9]/g, '');
}

// Data passed from Flask, parsed into JavaScript objects
const DEFAULT_HAB_WEIGHTS = JSON.parse('{{ default_hab_weights_json|safe }}');
const DEFAULT_PHI_WEIGHTS = JSON.parse('{{ default_phi_weights_json|safe }}');
const CURRENT_GLOBAL_HAB_WEIGHTS = JSON.parse('{{ current_global_hab_weights_json|safe }}');
const CURRENT_GLOBAL_PHI_WEIGHTS = JSON.parse('{{ current_global_phi_weights_json|safe }}');
const CURRENT_PLANET_SPECIFIC_WEIGHTS = JSON.parse('{{ current_planet_specific_weights_json|safe }}');
const INITIAL_HAB_WEIGHTS = JSON.parse('{{ initial_hab_weights_json|safe }}');
const INITIAL_PHI_WEIGHTS = JSON.parse('{{ initial_phi_weights_json|safe }}');
const USE_INDIVIDUAL_WEIGHTS_ON_LOAD = {{ use_individual_weights_val|lower }};

document.addEventListener('DOMContentLoaded', function() {
    const weightDescriptions = {
        'habitable_zone': 'How important is the planet\'s position in the habitable zone.',
        'size': 'How important is the planet\'s size relative to Earth.',
        'density': 'How important is the planet\'s density relative to Earth.',
        'atmosphere': 'How important is the potential for an atmosphere.',
        'water': 'How important is the potential for liquid water.',
        'presence_of_moons': 'How important is the presence of moons for habitability.',
        'magnetic_activity': 'How important is the star\'s magnetic activity.',
        'system_age': 'How important is the age of the star system.',
        'solid_surface': 'How important is a solid surface for habitability (PHI).',
        'stable_energy': 'How important is stable energy from the star (PHI).',
        'life_compounds': 'How important are compounds necessary for life (PHI).',
        'stable_orbit': 'How important is a stable orbit (PHI).'
    };

    const habFactorDefinitions = [
        { key: 'habitable_zone', label: 'Habitable Zone', defaultVal: DEFAULT_HAB_WEIGHTS['Habitable Zone'] || 1.0, min: 0, max: 1, step: 0.01 },
        { key: 'size', label: 'Size', defaultVal: DEFAULT_HAB_WEIGHTS['Size'] || 1.0, min: 0, max: 1, step: 0.01 },
        { key: 'density', label: 'Density', defaultVal: DEFAULT_HAB_WEIGHTS['Density'] || 1.0, min: 0, max: 1, step: 0.01 },
        { key: 'atmosphere', label: 'Atmosphere', defaultVal: DEFAULT_HAB_WEIGHTS['Atmosphere'] || 1.0, min: 0, max: 1, step: 0.01 },
        { key: 'water', label: 'Water', defaultVal: DEFAULT_HAB_WEIGHTS['Water'] || 1.0, min: 0, max: 1, step: 0.01 },
        { key: 'presence_of_moons', label: 'Presence of Moons', defaultVal: DEFAULT_HAB_WEIGHTS['Presence of Moons'] || 1.0, min: 0, max: 1, step: 0.01 },
        { key: 'magnetic_activity', label: 'Magnetic Activity', defaultVal: DEFAULT_HAB_WEIGHTS['Magnetic Activity'] || 1.0, min: 0, max: 1, step: 0.01 },
        { key: 'system_age', label: 'System Age', defaultVal: DEFAULT_HAB_WEIGHTS['System Age'] || 1.0, min: 0, max: 1, step: 0.01 }
    ];

    const phiFactorDefinitions = [
        { key: 'solid_surface', label: 'Solid Surface', defaultVal: DEFAULT_PHI_WEIGHTS['Solid Surface'] || 0.25, min: 0, max: 0.25, step: 0.01 },
        { key: 'stable_energy', label: 'Stable Energy', defaultVal: DEFAULT_PHI_WEIGHTS['Stable Energy'] || 0.25, min: 0, max: 0.25, step: 0.01 },
        { key: 'life_compounds', label: 'Life Compounds', defaultVal: DEFAULT_PHI_WEIGHTS['Life Compounds'] || 0.25, min: 0, max: 0.25, step: 0.01 },
        { key: 'stable_orbit', label: 'Stable Orbit', defaultVal: DEFAULT_PHI_WEIGHTS['Stable Orbit'] || 0.25, min: 0, max: 0.25, step: 0.01 }
    ];

    const useIndividualWeightsCheckbox = document.getElementById('use-individual-weights');
    const planetWeightsContainer = document.getElementById('planet-weights-container');
    const saveButtonContainer = document.getElementById('save-individual-weights-button-container');

    if (USE_INDIVIDUAL_WEIGHTS_ON_LOAD) {
        useIndividualWeightsCheckbox.checked = true;
        planetWeightsContainer.style.display = 'block';
        saveButtonContainer.style.display = 'block';
        loadPlanetWeightsUI();
    }

    if (useIndividualWeightsCheckbox && planetWeightsContainer) {
        useIndividualWeightsCheckbox.addEventListener('change', function() {
            if (this.checked) {
                planetWeightsContainer.style.display = 'block';
                saveButtonContainer.style.display = 'block';
                loadPlanetWeightsUI();
            } else {
                planetWeightsContainer.style.display = 'none';
                saveButtonContainer.style.display = 'none';
            }
        });
    }

    function getWeightValue(planetNormalizedName, category, weightKey) {
        const factorDef = (category === 'hab' ? habFactorDefinitions : phiFactorDefinitions).find(f => f.key === weightKey);
        if (!factorDef) {
            console.warn(`Factor definition not found for key: ${weightKey} in category: ${category}`);
            return (category === 'hab' ? 1.0 : 0.25);
        }

        const displayNameKey = factorDef.label;

        // Usar pesos iniciais para habitability ou PHI
        if (category === 'hab' && INITIAL_HAB_WEIGHTS[planetNormalizedName] && INITIAL_HAB_WEIGHTS[planetNormalizedName][displayNameKey] !== undefined) {
            console.log(`Using INITIAL_HAB_WEIGHTS for ${planetNormalizedName}, ${displayNameKey}: ${INITIAL_HAB_WEIGHTS[planetNormalizedName][displayNameKey]}`);
            return INITIAL_HAB_WEIGHTS[planetNormalizedName][displayNameKey];
        }
        if (category === 'phi' && INITIAL_PHI_WEIGHTS[planetNormalizedName] && INITIAL_PHI_WEIGHTS[planetNormalizedName][displayNameKey] !== undefined) {
            console.log(`Using INITIAL_PHI_WEIGHTS for ${planetNormalizedName}, ${displayNameKey}: ${INITIAL_PHI_WEIGHTS[planetNormalizedName][displayNameKey]}`);
            return INITIAL_PHI_WEIGHTS[planetNormalizedName][displayNameKey];
        }

        if (CURRENT_PLANET_SPECIFIC_WEIGHTS &&
            CURRENT_PLANET_SPECIFIC_WEIGHTS[planetNormalizedName] &&
            CURRENT_PLANET_SPECIFIC_WEIGHTS[planetNormalizedName][category] &&
            CURRENT_PLANET_SPECIFIC_WEIGHTS[planetNormalizedName][category][displayNameKey] !== undefined) {
            console.log(`Using CURRENT_PLANET_SPECIFIC_WEIGHTS for ${planetNormalizedName}, ${displayNameKey}: ${CURRENT_PLANET_SPECIFIC_WEIGHTS[planetNormalizedName][category][displayNameKey]}`);
            return CURRENT_PLANET_SPECIFIC_WEIGHTS[planetNormalizedName][category][displayNameKey];
        }

        const globalCategoryWeights = category === 'hab' ? CURRENT_GLOBAL_HAB_WEIGHTS : CURRENT_GLOBAL_PHI_WEIGHTS;
        if (globalCategoryWeights && globalCategoryWeights[displayNameKey] !== undefined) {
            console.log(`Using global weights for ${planetNormalizedName}, ${displayNameKey}: ${globalCategoryWeights[displayNameKey]}`);
            return globalCategoryWeights[displayNameKey];
        }
        
        console.log(`Using default value for ${planetNormalizedName}, ${displayNameKey}: ${factorDef.defaultVal}`);
        return factorDef.defaultVal;
    }

    async function loadPlanetWeightsUI() {
        try {
            const response = await fetch('/api/planets/reference-values');
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const data = await response.json();

            if (!planetWeightsContainer) return;

            if (data.planets && data.planets.length > 0) {
                let html = '';
                data.planets.forEach((planet, index) => {
                    const planetNormalizedName = normalizePlanetName(planet.name);
                    console.log(`Loading UI for planet: ${planet.name}, normalized: ${planetNormalizedName}`);
                    html += `
                        <div class="card mb-3 planet-weight-card" data-planet-normalized-name="${planetNormalizedName}" data-planet-display-name="${planet.name}">
                            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                                <h5>Habitability Factor Weights (ESI, SPH, PHI, etc.) for ${planet.name}</h5>
                                <button type="button" class="btn btn-sm btn-outline-light reset-planet-weights-btn" data-planet-normalized-name="${planetNormalizedName}">Reset to Defaults</button>
                            </div>
                            <div class="card-body">
                                <ul class="nav nav-tabs" role="tablist">
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link active" id="hab-tab-${index}" data-bs-toggle="tab" data-bs-target="#hab-content-${index}" type="button" role="tab">Habitability Factors</button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="phi-tab-${index}" data-bs-toggle="tab" data-bs-target="#phi-content-${index}" type="button" role="tab">PHI Factors</button>
                                    </li>
                                </ul>
                                <div class="tab-content pt-3">
                                    <div class="tab-pane fade show active" id="hab-content-${index}" role="tabpanel">
                                        <div class="row">`;
                    habFactorDefinitions.forEach(factor => {
                        const currentValue = getWeightValue(planetNormalizedName, 'hab', factor.key);
                        html += `
                            <div class="col-md-6 mb-3">
                                <label class="form-label">${factor.label}</label>
                                <div class="input-group">
                                    <input type="range" class="form-range planet-weight-slider"
                                           data-planet-normalized-name="${planetNormalizedName}" data-weight-key="${factor.key}" data-weight-type="hab"
                                           min="${factor.min}" max="${factor.max}" step="${factor.step}" value="${currentValue}">
                                    <input type="number" class="form-control planet-weight-input"
                                           data-planet-normalized-name="${planetNormalizedName}" data-weight-key="${factor.key}" data-weight-type="hab"
                                           min="${factor.min}" max="${factor.max}" step="${factor.step}" value="${currentValue}" style="width: 80px;">
                                </div>
                                <small class="form-text text-muted weight-description" data-weight="${factor.key}">${weightDescriptions[factor.key] || ''}</small>
                            </div>`;
                    });
                    html += `       </div>
                                </div>
                                <div class="tab-pane fade" id="phi-content-${index}" role="tabpanel">
                                    <div class="row">`;
                    phiFactorDefinitions.forEach(factor => {
                        const currentValue = getWeightValue(planetNormalizedName, 'phi', factor.key);
                        html += `
                            <div class="col-md-6 mb-3">
                                <label class="form-label">${factor.label}</label>
                                <div class="input-group">
                                    <input type="range" class="form-range planet-weight-slider"
                                           data-planet-normalized-name="${planetNormalizedName}" data-weight-key="${factor.key}" data-weight-type="phi"
                                           min="${factor.min}" max="${factor.max}" step="${factor.step}" value="${currentValue}">
                                    <input type="number" class="form-control planet-weight-input"
                                           data-planet-normalized-name="${planetNormalizedName}" data-weight-key="${factor.key}" data-weight-type="phi"
                                           min="${factor.min}" max="${factor.max}" step="${factor.step}" value="${currentValue}" style="width: 80px;">
                                </div>
                                <small class="form-text text-muted weight-description" data-weight="${factor.key}">${weightDescriptions[factor.key] || ''}</small>
                            </div>`;
                    });
                    html += `       </div>
                                </div>
                            </div>
                            <div class="card-footer d-flex justify-content-end">
                                <button type="button" class="btn btn-success save-individual-weights-btn" data-planet-normalized-name="${planetNormalizedName}" data-planet-display-name="${planet.name}">Save ${planet.name} Weights</button>
                            </div>
                        </div>`;
                });
                planetWeightsContainer.innerHTML = html;
                setupPlanetWeightControls();
                setupResetButtons();
                setupIndividualSaveButtons();
            } else {
                planetWeightsContainer.innerHTML = '<div class="alert alert-info">No exoplanets selected. Make a search first.</div>';
            }
        } catch (error) {
            console.error('Error loading planet weights UI:', error);
            if (planetWeightsContainer) {
                planetWeightsContainer.innerHTML = `<div class="alert alert-danger">Error loading planet weights: ${error.message}</div>`;
            }
        }
    }

    function setupIndividualSaveButtons() {
        document.querySelectorAll('.save-individual-weights-btn').forEach(button => {
            button.addEventListener('click', async function() {
                const planetNormalizedName = this.dataset.planetNormalizedName;
                const planetDisplayName = this.dataset.planetDisplayName;
                const useIndividual = useIndividualWeightsCheckbox.checked;
                let collectedWeights = {};

                const card = document.querySelector(`.planet-weight-card[data-planet-normalized-name="${planetNormalizedName}"]`);
                if (!card) return;

                let currentPlanetHabWeights = {};
                let currentPlanetPhiWeights = {};
                let hasChanges = false;

                const initialHab = INITIAL_HAB_WEIGHTS[planetNormalizedName] || {};
                const initialPhi = INITIAL_PHI_WEIGHTS[planetNormalizedName] || {};

                habFactorDefinitions.forEach(factorDef => {
                    const inputElement = card.querySelector(`.planet-weight-input[data-weight-type="hab"][data-weight-key="${factorDef.key}"]`);
                    if (inputElement) {
                        const val = parseFloat(inputElement.value);
                        currentPlanetHabWeights[factorDef.label] = val;
                        if (Math.abs(val - (initialHab[factorDef.label] ?? factorDef.defaultVal)) > 1e-9) {
                            hasChanges = true;
                        }
                    }
                });

                phiFactorDefinitions.forEach(factorDef => {
                    const inputElement = card.querySelector(`.planet-weight-input[data-weight-type="phi"][data-weight-key="${factorDef.key}"]`);
                    if (inputElement) {
                        const val = parseFloat(inputElement.value);
                        currentPlanetPhiWeights[factorDef.label] = val;
                        if (Math.abs(val - (initialPhi[factorDef.label] ?? factorDef.defaultVal)) > 1e-9) {
                            hasChanges = true;
                        }
                    }
                });

                if (hasChanges) {
                    collectedWeights[planetNormalizedName] = {
                        habitability: currentPlanetHabWeights,
                        phi: currentPlanetPhiWeights
                    };
                }

                console.log(`Saving weights for ${planetDisplayName}:`, {
                    use_individual_weights: useIndividual && Object.keys(collectedWeights).length > 0,
                    planet_weights: collectedWeights
                });

                try {
                    const response = await fetch('/api/save-planet-weights', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            use_individual_weights: useIndividual && Object.keys(collectedWeights).length > 0,
                            planet_weights: collectedWeights
                        })
                    });
                    if (!response.ok) throw new Error(`Failed to save weights for ${planetDisplayName}: ${response.status}`);
                    const result = await response.json();
                    if (result.status === 'success') {
                        alert(`Weights for ${planetDisplayName} saved successfully!`);
                        if (result.saved_weights && result.saved_weights[planetNormalizedName]) {
                            CURRENT_PLANET_SPECIFIC_WEIGHTS[planetNormalizedName] = result.saved_weights[planetNormalizedName];
                        } else {
                            delete CURRENT_PLANET_SPECIFIC_WEIGHTS[planetNormalizedName];
                        }
                        await loadReferenceValues();
                    } else {
                        alert(`Error saving weights for ${planetDisplayName}.`);
                    }
                } catch (error) {
                    console.error(`Error saving weights for ${planetDisplayName}:`, error);
                    alert(`Error saving weights for ${planetDisplayName}: ${error.message}`);
                }
            });
        });
    }

    function setupPlanetWeightControls() {
        document.querySelectorAll('.planet-weight-slider').forEach(slider => {
            const planetName = slider.dataset.planetNormalizedName;
            const weightKey = slider.dataset.weightKey;
            const weightType = slider.dataset.weightType;
            const inputField = document.querySelector(`.planet-weight-input[data-planet-normalized-name="${planetName}"][data-weight-key="${weightKey}"][data-weight-type="${weightType}"]`);

            if (inputField) {
                slider.addEventListener('input', function() { inputField.value = this.value; });
            }
        });

        document.querySelectorAll('.planet-weight-input').forEach(input => {
            const planetName = input.dataset.planetNormalizedName;
            const weightKey = input.dataset.weightKey;
            const weightType = input.dataset.weightType;
            const slider = document.querySelector(`.planet-weight-slider[data-planet-normalized-name="${planetName}"][data-weight-key="${weightKey}"][data-weight-type="${weightType}"]`);

            if (slider) {
                input.addEventListener('input', function() { slider.value = this.value; });
            }
        });
    }

    function setupResetButtons() {
        document.querySelectorAll('.reset-planet-weights-btn').forEach(button => {
            button.addEventListener('click', function() {
                const planetNormalizedName = this.dataset.planetNormalizedName;
                
                habFactorDefinitions.forEach(factor => {
                    const slider = document.querySelector(`.planet-weight-slider[data-planet-normalized-name="${planetNormalizedName}"][data-weight-key="${factor.key}"][data-weight-type="hab"]`);
                    const input = document.querySelector(`.planet-weight-input[data-planet-normalized-name="${planetNormalizedName}"][data-weight-key="${factor.key}"][data-weight-type="hab"]`);
                    const initialValue = INITIAL_HAB_WEIGHTS[planetNormalizedName]?.[factor.label] ?? factor.defaultVal;
                    console.log(`Resetting ${planetNormalizedName}, ${factor.label} to ${initialValue}`);
                    if (slider) slider.value = initialValue;
                    if (input) input.value = initialValue;
                });

                phiFactorDefinitions.forEach(factor => {
                    const slider = document.querySelector(`.planet-weight-slider[data-planet-normalized-name="${planetNormalizedName}"][data-weight-key="${factor.key}"][data-weight-type="phi"]`);
                    const input = document.querySelector(`.planet-weight-input[data-planet-normalized-name="${planetNormalizedName}"][data-weight-key="${factor.key}"][data-weight-type="phi"]`);
                    const initialValue = INITIAL_PHI_WEIGHTS[planetNormalizedName]?.[factor.label] ?? factor.defaultVal;
                    console.log(`Resetting ${planetNormalizedName}, ${factor.label} to ${initialValue}`);
                    if (slider) slider.value = initialValue;
                    if (input) input.value = initialValue;
                });
            });
        });
    }

    const saveAllButton = document.getElementById('save-all-individual-weights-btn');
    if (saveAllButton) {
        saveAllButton.addEventListener('click', async function() {
            const useIndividual = useIndividualWeightsCheckbox.checked;
            const collectedWeights = {};

            document.querySelectorAll('.planet-weight-card').forEach(card => {
                const planetDisplayName = card.dataset.planetDisplayName;
                const planetNormalizedName = normalizePlanetName(planetDisplayName);

                let currentPlanetHabWeights = {};
                let currentPlanetPhiWeights = {};
                let hasChanges = false;

                const initialHab = INITIAL_HAB_WEIGHTS[planetNormalizedName] || {};
                const initialPhi = INITIAL_PHI_WEIGHTS[planetNormalizedName] || {};

                habFactorDefinitions.forEach(factorDef => {
                    const inputElement = card.querySelector(`.planet-weight-input[data-weight-type="hab"][data-weight-key="${factorDef.key}"]`);
                    if (inputElement) {
                        const val = parseFloat(inputElement.value);
                        currentPlanetHabWeights[factorDef.label] = val;
                        if (Math.abs(val - (initialHab[factorDef.label] ?? factorDef.defaultVal)) > 1e-9) {
                            hasChanges = true;
                        }
                    }
                });

                phiFactorDefinitions.forEach(factorDef => {
                    const inputElement = card.querySelector(`.planet-weight-input[data-weight-type="phi"][data-weight-key="${factorDef.key}"]`);
                    if (inputElement) {
                        const val = parseFloat(inputElement.value);
                        currentPlanetPhiWeights[factorDef.label] = val;
                        if (Math.abs(val - (initialPhi[factorDef.label] ?? factorDef.defaultVal)) > 1e-9) {
                            hasChanges = true;
                        }
                    }
                });

                if (hasChanges) {
                    collectedWeights[planetNormalizedName] = {
                        habitability: currentPlanetHabWeights,
                        phi: currentPlanetPhiWeights
                    };
                }
            });

            console.log('Sending weights to API:', {
                use_individual_weights: useIndividual && Object.keys(collectedWeights).length > 0,
                planet_weights: collectedWeights
            });

            try {
                const response = await fetch('/api/save-planet-weights', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        use_individual_weights: useIndividual && Object.keys(collectedWeights).length > 0,
                        planet_weights: collectedWeights
                    })
                });
                if (!response.ok) throw new Error(`Failed to save weights: ${response.status}`);
                const result = await response.json();
                if (result.status === 'success') {
                    alert('Individual planet weights saved successfully!');
                    CURRENT_PLANET_SPECIFIC_WEIGHTS = result.saved_weights || {};
                    await loadReferenceValues();
                } else {
                    alert('Error saving weights.');
                }
            } catch (error) {
                console.error('Error saving planet weights:', error);
                alert('Error saving weights: ' + error.message);
            }
        });
    }

    async function loadReferenceValues() {
        try {
            const useIndividual = useIndividualWeightsCheckbox.checked;
            const payload = {
                use_individual_weights: useIndividual && Object.keys(CURRENT_PLANET_SPECIFIC_WEIGHTS).length > 0,
                planet_weights: useIndividual ? CURRENT_PLANET_SPECIFIC_WEIGHTS : {}
            };
            console.log('Sending reference values request:', payload);

            const response = await fetch('/api/planets/reference_values', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            const tableBody = document.getElementById('reference_values');
            tableBody.innerHTML = '';

            if (data.planets && data.planets.length > 0) {
                data.planets.forEach(planet => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${planet.name}</td>
                        <td>${(planet.esi).toFixed(2)}%</td>
                        <td>${(planet.phi).toFixed(2)}%</td>
                        <td>${planet.classification}</td>
                    `;
                    tableBody.appendChild(row);
                });
            } else {
                tableBody.innerHTML = '<tr><td colspan="4" class="text-center">No reference data available</td></tr>';
            }
        } catch (error) {
            console.error('Error loading reference values:', error);
            tableBody.innerHTML = `<tr><td colspan="4" class="text-center text-danger">Failed to load reference values: ${error.message}</td></tr>`;
        }
    }

    // Carregar valores de referência apenas se a tabela estiver vazia
    const existingRows = document.querySelectorAll('#reference_values tr');
    if (existingRows.length === 0 && document.getElementById('reference-values-table')) {
        loadReferenceValues();
    }
});
</script>

<style>
.planet-weight-slider {
    background-color: #e8f4ff;
    border-color: #007bff;
}

.planet-weight-input {
    text-align: center;
}

.form-range {
    flex-grow: 1;
    margin-right: 10px;
}

.input-group {
    display: flex;
    align-items: center;
}
</style>
{% endblock %}